const translations = {
  it: {
    nav_overview: "Chi siamo",
    nav_market: "Mercato",
    nav_positioning: "Posizionamento",
    nav_solution: "Soluzione",
    nav_business: "Modello",
    nav_financials: "Finanza",
    nav_impact: "Impatto",
    nav_roadmap: "Roadmap",
    nav_team: "Team",
    nav_contact: "Contatti",
    hero_kicker: "Circular pharma platform",
    hero_title: "PharmaSave trasforma lo spreco farmaceutico in valore tracciabile.",
    hero_subtitle: "Piattaforma B2B cross-border per recuperare farmaci in eccedenza prima della scadenza, con logistica GDP, repackaging GMP e metriche ESG integrate.",
    hero_primary: "Attiva una partnership",
    hero_secondary: "Vedi i numeri",
    cta_demo: "Vedi la demo",
    demo_title: "Richiedi accesso alla demo",
    demo_subtitle: "Compila il form per ricevere il link riservato alla demo.",
    demo_first_name_label: "Nome",
    demo_last_name_label: "Cognome",
    demo_email_label: "Email",
    demo_phone_label: "Cellulare",
    demo_company_label: "Nome azienda",
    demo_terms_accept: "Accetto i",
    demo_terms_link: "Termini e condizioni",
    demo_privacy_accept: "Accetto la",
    demo_privacy_link: "Privacy policy",
    demo_submit: "Invia e vai alla demo",
    hero_metrics_kicker: "Indicatori chiave",
    hero_metric1_value: "8B EUR",
    hero_metric1_label: "spreco annuo di farmaci in Italia",
    hero_metric2_value: "881 t",
    hero_metric2_label: "farmaci inceneriti in Italia ogni anno",
    hero_metric3_value: "39.8B USD",
    hero_metric3_label: "mercato globale waste management (2023)",
    hero_metric4_value: "7.7% CAGR",
    hero_metric4_label: "crescita annua prevista al 2032",
    overview_kicker: "Identita",
    overview_title: "Chi e PharmaSave",
    overview_subtitle: "Un hub digitale che connette produttori, distributori, ospedali e ONG per ridurre lo spreco e garantire accesso ai farmaci in carenza.",
    overview_card1_title: "Mission",
    overview_card1_body: "Recuperare eccedenze farmaceutiche e redistribuirle in modo sicuro, tracciabile e conforme, riducendo spreco economico e ambientale.",
    overview_card2_title: "Vision",
    overview_card2_body: "Un settore farmaceutico senza sprechi inutili, con una supply chain circolare e responsabile a scala europea.",
    overview_card3_title: "Identita operativa",
    overview_card3_body: "Modello asset-light: tecnologia proprietaria, rete di partner GDP/GMP, governance dati e compliance by design.",
    market_kicker: "Contesto",
    market_title: "Mercato attuale e perche ora",
    market_subtitle: "Spreco, carenze e pressione ESG stanno creando un mercato pronto per piattaforme B2B affidabili e misurabili.",
    market_card1_title: "Spreco strutturale",
    market_card1_body: "In Italia lo spreco stimato supera 8B EUR l anno e una quota rilevante di farmaci finisce in incenerimento. In UE fino al 20% dei farmaci viene sprecato ogni anno.",
    market_card2_title: "Carenze croniche",
    market_card2_body: "Le carenze di medicinali sono diffuse e persistenti in tutta Europa: fino al 95% dei farmacisti ospedalieri segnala shortage ricorrenti.",
    market_card3_title: "ESG e regolazione",
    market_card3_body: "Le aziende devono dimostrare riduzione di rifiuti ed emissioni. Servono dati verificabili e processi tracciati.",
    market_card4_title: "Mercato in espansione",
    market_card4_body: "Il waste management farmaceutico e un mercato globale da decine di miliardi, con crescita sostenuta fino al 2032.",
    positioning_kicker: "Vantaggio competitivo",
    positioning_title: "Come si posiziona PharmaSave",
    positioning_subtitle: "Un modello end-to-end che unisce marketplace, compliance e impatto misurabile.",
    positioning_card1_title: "B2B cross-border",
    positioning_card1_body: "Marketplace europeo per lotti in scadenza, con matching geografico e priorita alle aree in carenza.",
    positioning_card2_title: "Compliance integrata",
    positioning_card2_body: "GDP, GMP, serializzazione e controlli documentali unificati in un flusso digitale unico.",
    positioning_card3_title: "ESG misurabile",
    positioning_card3_body: "Dashboard con CO2 evitata, rifiuti speciali ridotti e valore recuperato per bilanci ESG.",
    positioning_card4_title: "Network effect",
    positioning_card4_body: "Piu partner sulla piattaforma, piu valore per tutti: dati, domanda e offerta in tempo reale.",
    solution_kicker: "Value creation",
    solution_title: "Cosa risolve e quali benefici porta",
    solution_subtitle: "PharmaSave converte eccedenze in valore economico, ambientale e sociale con un processo controllato.",
    solution_pill1: "Produttori",
    solution_card1_title: "Recupero valore e riduzione costi",
    solution_card1_body: "Monetizza lotti a rischio scadenza, evita costi di smaltimento e migliora KPI ESG.",
    solution_pill2: "Ospedali e ONG",
    solution_card2_title: "Accesso rapido a farmaci disponibili",
    solution_card2_body: "Riduce tempi di approvvigionamento e garantisce disponibilita a costi piu bassi.",
    solution_pill3: "Enti pubblici",
    solution_card3_title: "Sistema sanitario piu efficiente",
    solution_card3_body: "Dati trasparenti, minori rifiuti speciali e supporto alla sicurezza di approvvigionamento.",
    flow_kicker: "Operativita",
    flow_title: "Come funziona PharmaSave",
    flow_subtitle: "Processo digitale in 4 fasi, con tracciabilita end-to-end.",
    flow_step1_label: "Fase 1",
    flow_step1_title: "Caricamento lotti",
    flow_step1_body: "Produttori e grossisti inseriscono stock in eccedenza con documentazione di qualita.",
    flow_step2_label: "Fase 2",
    flow_step2_title: "Matching e verifica",
    flow_step2_body: "Algoritmi e team compliance validano requisiti e abbinano domanda e offerta.",
    flow_step3_label: "Fase 3",
    flow_step3_title: "Repackaging e logistica",
    flow_step3_body: "Partner GDP/GMP gestiscono trasporto controllato e riconfezionamento dove richiesto.",
    flow_step4_label: "Fase 4",
    flow_step4_title: "Consegna e report",
    flow_step4_body: "Ricezione confermata e aggiornamento automatico delle metriche ESG.",
    business_kicker: "Revenue",
    business_title: "Modello di business",
    business_subtitle: "Ricavi scalabili basati su transazioni, servizi premium e licensing internazionale.",
    business_card1_title: "Commissioni transazionali",
    business_card1_body: "Fee su ogni lotto venduto o donato, allineata al volume di scambi.",
    business_card2_title: "Logistica e repackaging",
    business_card2_body: "Servizi GDP/GMP aggiuntivi con tariffa per lotto e opzione full-service.",
    business_card3_title: "ESG analytics",
    business_card3_body: "Dashboard, report certificabili e KPI ambientali per la rendicontazione.",
    business_card4_title: "Licensing e programmi pubblici",
    business_card4_body: "White-label per grandi gruppi e progetti con enti pubblici o fondazioni.",
    financials_kicker: "Proiezioni",
    financials_title: "Impatto economico sul mercato",
    financials_subtitle: "Confronto tra mercato con e senza PharmaSave sui volumi attesi 2026-2032.",
    financials_toggle_caption: "Scenario grafico",
    financials_toggle_without: "Senza PharmaSave",
    financials_toggle_with: "Con PharmaSave",
    financials_toggle_status_with: "Scenario attivo: con PharmaSave",
    financials_toggle_status_without: "Scenario attivo: senza PharmaSave",
    financials_chart_title: "Valore economico generato (kEUR)",
    financials_label_primary_with: "Valore recuperato",
    financials_label_secondary_with: "Costi di smaltimento evitati",
    financials_label_primary_without: "Valore perso",
    financials_label_secondary_without: "Costi di smaltimento",
    financials_table_year: "Anno",
    financials_kpi1_title: "Valore transato stimato",
    financials_kpi1_body: "Derivato dai volumi attesi e da un take-rate B2B competitivo.",
    financials_kpi2_title: "Risparmio per la filiera",
    financials_kpi2_body: "Riduzione di perdite economiche e costi di smaltimento.",
    financials_kpi3_title: "Effetto sistema",
    financials_kpi3_body: "Ogni lotto salvato libera budget per cure e disponibilita.",
    impact_kicker: "Benessere",
    impact_title: "Impatto misurabile: prima e dopo PharmaSave",
    impact_subtitle: "Valori target su 12 mesi con 150 lotti redistribuiti e supply chain controllata.",
    impact_target_title: "Target 12 mesi",
    impact_target_body: "150 lotti, 150k confezioni salvate, logistica GDP attiva, dashboard ESG certificabile.",
    impact_target_cta: "Costruiamo il pilot",
    impact_card1_label: "Farmaci salvati",
    impact_card2_label: "Rifiuti speciali ridotti",
    impact_card3_label: "CO2 evitata",
    impact_before_label: "Prima di PharmaSave",
    impact_after_label: "Dopo PharmaSave",
    impact_metric_packs: "Confezioni salvate",
    impact_metric_waste: "Rifiuti speciali",
    impact_metric_co2: "CO2 evitata",
    impact_unit_packs: "confezioni",
    impact_unit_waste: "t",
    impact_unit_co2: "t CO2e",
    roadmap_kicker: "Roadmap",
    roadmap_title: "Crescita per fasi",
    roadmap_subtitle: "Validazione in Italia, espansione UE e scalabilita industriale.",
    roadmap_phase1_time: "0-12 mesi",
    roadmap_phase1_title: "MVP e primi partner",
    roadmap_phase1_body: "Lancio in Italia + 1 Paese UE, 20-30 partner, 150 lotti redistribuiti.",
    roadmap_phase2_time: "12-24 mesi",
    roadmap_phase2_title: "Hub GDP e repackaging",
    roadmap_phase2_body: "100 partner, 20k utenti, prime operazioni full-service.",
    roadmap_phase3_time: "24-36 mesi",
    roadmap_phase3_title: "Espansione EU",
    roadmap_phase3_body: "5+ mercati europei, AI per matching e monitoraggio IoT.",
    roadmap_phase4_time: "36-60 mesi",
    roadmap_phase4_title: "Scala europea",
    roadmap_phase4_body: "500+ partner, certificazioni ISO, readiness per exit o IPO.",
    compliance_kicker: "Trust",
    compliance_title: "Compliance e sicurezza integrate",
    compliance_subtitle: "Processi nativi per un settore altamente regolato.",
    compliance_card1_title: "Qualita e distribuzione",
    compliance_card1_item1: "Standard GDP per trasporto e stoccaggio",
    compliance_card1_item2: "Partner GMP per riconfezionamento",
    compliance_card1_item3: "Catena del freddo monitorata",
    compliance_card2_title: "Tracciabilita e antifrode",
    compliance_card2_item1: "Serializzazione e audit trail",
    compliance_card2_item2: "Documentazione lotti completa",
    compliance_card2_item3: "Controlli su autorizzazioni",
    compliance_card3_title: "Dati e responsabilita",
    compliance_card3_item1: "GDPR e data governance",
    compliance_card3_item2: "Assicurazioni e risk sharing",
    compliance_card3_item3: "Contratti e SLA trasparenti",
    team_kicker: "Founder",
    team_title: "Team con competenze farmaceutiche e finanziarie",
    team_subtitle: "4 founder con esperienza in finance, supply chain e pharma.",
    team_member1_name: "Fabio Baccaro",
    team_member1_role: "Founder. Strategia finanziaria, stakeholder e sviluppo business.",
    team_member2_name: "Riccardo Luca",
    team_member2_role: "Co-founder. Pianificazione finanziaria e controllo di gestione.",
    team_member3_name: "Luigi Fortino",
    team_member3_role: "Co-founder. Expertise farmaceutica e innovazione clinica.",
    team_member4_name: "Vladyslav Apkhaidze",
    team_member4_role: "Co-founder. Supply chain e serializzazione farmaci.",
    commercial_kicker: "Commerciale",
    commercial_title: "Perche puntare su PharmaSave",
    commercial_subtitle: "Una piattaforma scalabile con impatto ESG tangibile e ritorno economico.",
    commercial_card1_title: "Pilot rapido",
    commercial_card1_body: "Avvio in 90 giorni con KPI condivisi e governance congiunta.",
    commercial_card2_title: "Enterprise rollout",
    commercial_card2_body: "Integrazione con sistemi esistenti e supporto multi-country.",
    commercial_card3_title: "Partnership strategiche",
    commercial_card3_body: "Opzioni per big pharma, grossisti, ospedali e programmi pubblici.",
    footer_title: "Pronti a chiudere il ciclo dello spreco?",
    footer_body: "Parliamo di partnership, pilot o integrazioni commerciali.",
    footer_email_label: "Email",
    footer_phone_label: "Telefono",
    footer_address_label: "Sede"
  },
  en: {
    nav_overview: "Overview",
    nav_market: "Market",
    nav_positioning: "Positioning",
    nav_solution: "Solution",
    nav_business: "Business",
    nav_financials: "Financials",
    nav_impact: "Impact",
    nav_roadmap: "Roadmap",
    nav_team: "Team",
    nav_contact: "Contact",
    hero_kicker: "Circular pharma platform",
    hero_title: "PharmaSave turns medicine waste into traceable value.",
    hero_subtitle: "A B2B cross-border platform that rescues excess stock before expiry, with GDP logistics, GMP repackaging and embedded ESG metrics.",
    hero_primary: "Start a partnership",
    hero_secondary: "See the numbers",
    cta_demo: "See the demo",
    demo_title: "Request demo access",
    demo_subtitle: "Fill out the form to receive the private demo link.",
    demo_first_name_label: "First name",
    demo_last_name_label: "Last name",
    demo_email_label: "Email",
    demo_phone_label: "Mobile phone",
    demo_company_label: "Company name",
    demo_terms_accept: "I accept the",
    demo_terms_link: "Terms and conditions",
    demo_privacy_accept: "I accept the",
    demo_privacy_link: "Privacy policy",
    demo_submit: "Submit and go to demo",
    hero_metrics_kicker: "Key indicators",
    hero_metric1_value: "8B EUR",
    hero_metric1_label: "annual medicine waste in Italy",
    hero_metric2_value: "881 t",
    hero_metric2_label: "medicines incinerated in Italy each year",
    hero_metric3_value: "39.8B USD",
    hero_metric3_label: "global waste management market (2023)",
    hero_metric4_value: "7.7% CAGR",
    hero_metric4_label: "forecast growth to 2032",
    overview_kicker: "Identity",
    overview_title: "Who is PharmaSave",
    overview_subtitle: "A digital hub connecting manufacturers, distributors, hospitals and NGOs to reduce waste and close shortage gaps.",
    overview_card1_title: "Mission",
    overview_card1_body: "Recover excess pharmaceutical stock and redistribute it safely, traceably and in compliance, cutting waste and emissions.",
    overview_card2_title: "Vision",
    overview_card2_body: "A pharma sector with zero unnecessary waste and a circular, resilient European supply chain.",
    overview_card3_title: "Operating model",
    overview_card3_body: "Asset-light platform with proprietary tech, GDP/GMP partners, and compliance-by-design workflows.",
    market_kicker: "Context",
    market_title: "Market today and why now",
    market_subtitle: "Waste, shortages and ESG pressure are creating a ready market for trusted B2B platforms.",
    market_card1_title: "Structural waste",
    market_card1_body: "In Italy, estimated waste exceeds 8B EUR per year and a significant share is incinerated. Across the EU up to 20% of medicines are wasted annually.",
    market_card2_title: "Persistent shortages",
    market_card2_body: "Medicine shortages are widespread across Europe: up to 95% of hospital pharmacists report recurring shortages.",
    market_card3_title: "ESG and regulation",
    market_card3_body: "Companies must prove reduced waste and emissions with verifiable data and traceability.",
    market_card4_title: "Growing market",
    market_card4_body: "Pharma waste management is a multi-billion market with sustained growth to 2032.",
    positioning_kicker: "Edge",
    positioning_title: "How PharmaSave is positioned",
    positioning_subtitle: "An end-to-end model combining marketplace, compliance and measurable impact.",
    positioning_card1_title: "B2B cross-border",
    positioning_card1_body: "European marketplace for near-expiry batches with geographic matching and shortage routing.",
    positioning_card2_title: "Integrated compliance",
    positioning_card2_body: "GDP, GMP, serialization and documentation in a single digital flow.",
    positioning_card3_title: "Measurable ESG",
    positioning_card3_body: "Dashboard with avoided CO2, reduced hazardous waste and value recovered.",
    positioning_card4_title: "Network effect",
    positioning_card4_body: "More partners generate more data, liquidity and value for the entire ecosystem.",
    solution_kicker: "Value creation",
    solution_title: "What it solves and the benefits",
    solution_subtitle: "PharmaSave converts excess into economic, environmental and social value with a controlled process.",
    solution_pill1: "Manufacturers",
    solution_card1_title: "Value recovery and cost reduction",
    solution_card1_body: "Monetize batches at risk of expiry, avoid disposal costs, improve ESG KPIs.",
    solution_pill2: "Hospitals and NGOs",
    solution_card2_title: "Fast access to available stock",
    solution_card2_body: "Shorter lead times and lower costs for essential medicines.",
    solution_pill3: "Public sector",
    solution_card3_title: "More efficient healthcare",
    solution_card3_body: "Transparent data, fewer hazardous wastes and improved supply security.",
    flow_kicker: "Operations",
    flow_title: "How PharmaSave works",
    flow_subtitle: "A 4-step digital process with end-to-end traceability.",
    flow_step1_label: "Step 1",
    flow_step1_title: "Batch upload",
    flow_step1_body: "Manufacturers and distributors list excess stock with quality documentation.",
    flow_step2_label: "Step 2",
    flow_step2_title: "Matching and checks",
    flow_step2_body: "Compliance validation and real-time matching of demand and supply.",
    flow_step3_label: "Step 3",
    flow_step3_title: "Repackaging and logistics",
    flow_step3_body: "GDP/GMP partners handle controlled transport and repackaging where needed.",
    flow_step4_label: "Step 4",
    flow_step4_title: "Delivery and ESG",
    flow_step4_body: "Confirmed receipt and automatic ESG impact reporting.",
    business_kicker: "Revenue",
    business_title: "Business model",
    business_subtitle: "Scalable revenue streams based on transactions, premium services and licensing.",
    business_card1_title: "Transaction fees",
    business_card1_body: "Fee per batch sold or donated, aligned with volume and liquidity.",
    business_card2_title: "Logistics and repackaging",
    business_card2_body: "GDP/GMP services with per-batch pricing and full-service option.",
    business_card3_title: "ESG analytics",
    business_card3_body: "Dashboards, certified reports and KPI visibility for ESG reporting.",
    business_card4_title: "Licensing and public programs",
    business_card4_body: "White-label for large groups and projects with public entities or foundations.",
    financials_kicker: "Projections",
    financials_title: "Market economic impact",
    financials_subtitle: "Comparison between market scenarios with and without PharmaSave (2026-2032).",
    financials_toggle_caption: "Scenario view",
    financials_toggle_without: "Without PharmaSave",
    financials_toggle_with: "With PharmaSave",
    financials_toggle_status_with: "Active scenario: with PharmaSave",
    financials_toggle_status_without: "Active scenario: without PharmaSave",
    financials_chart_title: "Economic value generated (kEUR)",
    financials_label_primary_with: "Value recovered",
    financials_label_secondary_with: "Disposal costs avoided",
    financials_label_primary_without: "Value lost",
    financials_label_secondary_without: "Disposal costs",
    financials_table_year: "Year",
    financials_kpi1_title: "Estimated traded value",
    financials_kpi1_body: "Derived from expected volumes and a competitive B2B take rate.",
    financials_kpi2_title: "Supply-chain savings",
    financials_kpi2_body: "Reduced value loss and disposal costs.",
    financials_kpi3_title: "System effect",
    financials_kpi3_body: "Each saved batch unlocks budget for care and availability.",
    impact_kicker: "Wellbeing",
    impact_title: "Measurable impact: before and after PharmaSave",
    impact_subtitle: "12-month target values with 150 batches redistributed and controlled supply chain.",
    impact_target_title: "12-month target",
    impact_target_body: "150 batches, 150k packs saved, GDP logistics active, ESG dashboard ready.",
    impact_target_cta: "Build the pilot",
    impact_card1_label: "Medicines saved",
    impact_card2_label: "Hazardous waste reduced",
    impact_card3_label: "CO2 avoided",
    impact_before_label: "Before PharmaSave",
    impact_after_label: "After PharmaSave",
    impact_metric_packs: "Packs saved",
    impact_metric_waste: "Hazardous waste",
    impact_metric_co2: "CO2 avoided",
    impact_unit_packs: "packs",
    impact_unit_waste: "t",
    impact_unit_co2: "t CO2e",
    roadmap_kicker: "Roadmap",
    roadmap_title: "Growth by phases",
    roadmap_subtitle: "Validation in Italy, EU expansion and industrial scale.",
    roadmap_phase1_time: "0-12 months",
    roadmap_phase1_title: "MVP and first partners",
    roadmap_phase1_body: "Launch in Italy + 1 EU country, 20-30 partners, 150 batches.",
    roadmap_phase2_time: "12-24 months",
    roadmap_phase2_title: "GDP hubs and repackaging",
    roadmap_phase2_body: "100 partners, 20k users, first full-service operations.",
    roadmap_phase3_time: "24-36 months",
    roadmap_phase3_title: "EU expansion",
    roadmap_phase3_body: "5+ EU markets, AI matching and IoT monitoring.",
    roadmap_phase4_time: "36-60 months",
    roadmap_phase4_title: "European scale",
    roadmap_phase4_body: "500+ partners, ISO certifications, exit or IPO readiness.",
    compliance_kicker: "Trust",
    compliance_title: "Compliance and safety built in",
    compliance_subtitle: "Native processes for a highly regulated sector.",
    compliance_card1_title: "Quality and distribution",
    compliance_card1_item1: "GDP standards for transport and storage",
    compliance_card1_item2: "GMP partners for repackaging",
    compliance_card1_item3: "Cold chain monitoring",
    compliance_card2_title: "Traceability and anti-fraud",
    compliance_card2_item1: "Serialization and audit trail",
    compliance_card2_item2: "Full batch documentation",
    compliance_card2_item3: "License and authorization checks",
    compliance_card3_title: "Data and responsibility",
    compliance_card3_item1: "GDPR and data governance",
    compliance_card3_item2: "Insurance and risk sharing",
    compliance_card3_item3: "Transparent contracts and SLAs",
    team_kicker: "Founder",
    team_title: "Team with pharma and finance expertise",
    team_subtitle: "4 founders with experience across finance, supply chain and pharma.",
    team_member1_name: "Fabio Baccaro",
    team_member1_role: "Founder. Financial strategy, stakeholder management and business growth.",
    team_member2_name: "Riccardo Luca",
    team_member2_role: "Co-founder. Financial planning and controlling.",
    team_member3_name: "Luigi Fortino",
    team_member3_role: "Co-founder. Pharma expertise and clinical innovation.",
    team_member4_name: "Vladyslav Apkhaidze",
    team_member4_role: "Co-founder. Supply chain and serialization systems.",
    commercial_kicker: "Commercial",
    commercial_title: "Why bet on PharmaSave",
    commercial_subtitle: "A scalable platform with tangible ESG impact and economic returns.",
    commercial_card1_title: "Fast pilot",
    commercial_card1_body: "Go-live in 90 days with shared KPIs and joint governance.",
    commercial_card2_title: "Enterprise rollout",
    commercial_card2_body: "Integration with existing systems and multi-country support.",
    commercial_card3_title: "Strategic partnerships",
    commercial_card3_body: "Options for big pharma, wholesalers, hospitals and public programs.",
    footer_title: "Ready to close the loop?",
    footer_body: "Lets talk about partnerships, pilots or commercial integration.",
    footer_email_label: "Email",
    footer_phone_label: "Phone",
    footer_address_label: "Location"
  }
};

const PIN_CODE = "2153";
const PIN_STORAGE_KEY = "pharmasave_pin_ok";

const financialScenarios = {
  with: {
    years: [2026, 2027, 2028, 2029, 2030, 2031, 2032],
    primary: [17081.1, 35621.6, 45232.4, 54248.6, 64473.0, 70000.0, 77989.2],
    secondary: [341.6, 712.4, 904.6, 1085.0, 1289.5, 1400.0, 1559.8]
  },
  without: {
    years: [2026, 2027, 2028, 2029, 2030, 2031, 2032],
    primary: [-17081.1, -35621.6, -45232.4, -54248.6, -64473.0, -70000.0, -77989.2],
    secondary: [-341.6, -712.4, -904.6, -1085.0, -1289.5, -1400.0, -1559.8]
  }
};

let currentScenario = "with";

const financialChartConfig = {
  width: 700,
  height: 260,
  padding: { top: 20, right: 20, bottom: 30, left: 50 },
  duration: 650
};

const financialChartState = {
  svg: null,
  scaleX: null,
  scaleY: null,
  yTicks: [],
  paths: { primary: null, secondary: null },
  dots: { primary: [], secondary: [] },
  currentData: null,
  currentScenario: null,
  animationId: null
};

const impactScenario = {
  packs: 150000,
  waste: 30,
  co2: 90
};


function formatNumber(value, lang) {
  const locale = lang === "it" ? "it-IT" : "en-US";
  return new Intl.NumberFormat(locale, { maximumFractionDigits: 1 }).format(value);
}

function setLang(lang) {
  const dict = translations[lang];
  document.documentElement.lang = lang;

  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) {
      el.innerHTML = dict[key];
    }
  });

  document.querySelectorAll(".lang-toggle button").forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.lang === lang);
  });

  updateFinancials(lang);
  renderImpact(lang);
}

function updateScenarioStatus(lang) {
  const status = document.getElementById("scenario-status");
  if (!status) return;
  const key =
    currentScenario === "with"
      ? "financials_toggle_status_with"
      : "financials_toggle_status_without";
  status.textContent = translations[lang][key];
}

function updateScenarioButtons() {
  document.querySelectorAll(".scenario-buttons button").forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.scenario === currentScenario);
  });
}

function updateFinancials(lang) {
  renderFinancialTable(lang, currentScenario);
  renderFinancialChart(lang, currentScenario);
  updateScenarioButtons();
  updateScenarioStatus(lang);
  updateFinancialLabels(lang);
}

function updateFinancialLabels(lang) {
  const dict = translations[lang];
  const primaryKey =
    currentScenario === "with"
      ? "financials_label_primary_with"
      : "financials_label_primary_without";
  const secondaryKey =
    currentScenario === "with"
      ? "financials_label_secondary_with"
      : "financials_label_secondary_without";

  document.querySelectorAll('[data-financial-label=\"primary\"]').forEach((el) => {
    el.textContent = dict[primaryKey];
  });
  document.querySelectorAll('[data-financial-label=\"secondary\"]').forEach((el) => {
    el.textContent = dict[secondaryKey];
  });
}

function setupScenarioToggle() {
  document.querySelectorAll(".scenario-buttons button").forEach((btn) => {
    btn.addEventListener("click", () => {
      currentScenario = btn.dataset.scenario;
      localStorage.setItem("pharmasave-scenario", currentScenario);
      const lang = document.documentElement.lang || "it";
      updateFinancials(lang);
    });
  });
}

function getFinancialDomain() {
  const allValues = Object.values(financialScenarios).flatMap((scenario) => [
    ...scenario.primary,
    ...scenario.secondary
  ]);
  const minVal = Math.min(...allValues);
  const maxVal = Math.max(...allValues);
  const maxAbs = Math.max(Math.abs(minVal), Math.abs(maxVal)) || 1;
  const pad = maxAbs * 0.15;
  const yMin = -maxAbs - pad;
  const yMax = maxAbs + pad;
  return { yMin, yMax };
}

function createSvgEl(name, attrs) {
  const el = document.createElementNS("http://www.w3.org/2000/svg", name);
  Object.entries(attrs).forEach(([key, val]) => el.setAttribute(key, val));
  return el;
}

function updateFinancialAxisLabels(lang) {
  financialChartState.yTicks.forEach(({ value, labelEl }) => {
    labelEl.textContent = formatNumber(value, lang);
  });
}

function initFinancialChart(lang) {
  if (financialChartState.svg) {
    updateFinancialAxisLabels(lang);
    return;
  }

  const svg = document.getElementById("financial-chart");
  if (!svg) return;

  financialChartState.svg = svg;

  const { width, height, padding } = financialChartConfig;
  const { yMin, yMax } = getFinancialDomain();
  const years = financialScenarios.with.years;

  const xStep = (width - padding.left - padding.right) / (years.length - 1);
  const yScale = (height - padding.top - padding.bottom) / (yMax - yMin);

  financialChartState.scaleX = (i) => padding.left + i * xStep;
  financialChartState.scaleY = (value) => padding.top + (yMax - value) * yScale;

  while (svg.firstChild) {
    svg.removeChild(svg.firstChild);
  }

  const defs = createSvgEl("defs", {});
  const gradPrimary = createSvgEl("linearGradient", {
    id: "chart-gradient-primary",
    x1: "0%",
    y1: "0%",
    x2: "100%",
    y2: "0%"
  });
  gradPrimary.appendChild(createSvgEl("stop", { offset: "0%", "stop-color": "#3E8F2B" }));
  gradPrimary.appendChild(createSvgEl("stop", { offset: "55%", "stop-color": "#7ED957" }));
  gradPrimary.appendChild(createSvgEl("stop", { offset: "100%", "stop-color": "#E6F7D8" }));

  const gradSecondary = createSvgEl("linearGradient", {
    id: "chart-gradient-secondary",
    x1: "0%",
    y1: "0%",
    x2: "100%",
    y2: "0%"
  });
  gradSecondary.appendChild(createSvgEl("stop", { offset: "0%", "stop-color": "#5A8F3A" }));
  gradSecondary.appendChild(createSvgEl("stop", { offset: "100%", "stop-color": "#B7F28A" }));

  const glow = createSvgEl("filter", {
    id: "chart-glow",
    x: "-40%",
    y: "-40%",
    width: "180%",
    height: "180%"
  });
  glow.appendChild(createSvgEl("feGaussianBlur", { stdDeviation: "3", result: "blur" }));
  const merge = createSvgEl("feMerge", {});
  merge.appendChild(createSvgEl("feMergeNode", { in: "blur" }));
  merge.appendChild(createSvgEl("feMergeNode", { in: "SourceGraphic" }));
  glow.appendChild(merge);

  defs.appendChild(gradPrimary);
  defs.appendChild(gradSecondary);
  defs.appendChild(glow);
  svg.appendChild(defs);

  const gridGroup = createSvgEl("g", { class: "chart-grid" });
  const gridCount = 5;
  financialChartState.yTicks = [];

  for (let i = 0; i <= gridCount; i += 1) {
    const yVal = yMin + (yMax - yMin) * (i / gridCount);
    const y = financialChartState.scaleY(yVal);
    gridGroup.appendChild(
      createSvgEl("line", {
        x1: padding.left,
        y1: y,
        x2: width - padding.right,
        y2: y,
        stroke: "rgba(12, 26, 14, 0.12)",
        "stroke-width": 1
      })
    );
    const label = createSvgEl("text", {
      x: 8,
      y: y + 4,
      fill: "rgba(12, 26, 14, 0.5)",
      "font-size": 10
    });
    label.textContent = formatNumber(yVal, lang);
    financialChartState.yTicks.push({ value: yVal, labelEl: label });
    gridGroup.appendChild(label);
  }

  if (yMin < 0 && yMax > 0) {
    const zeroY = financialChartState.scaleY(0);
    gridGroup.appendChild(
      createSvgEl("line", {
        x1: padding.left,
        y1: zeroY,
        x2: width - padding.right,
        y2: zeroY,
        stroke: "rgba(126, 217, 87, 0.45)",
        "stroke-width": 1
      })
    );
  }

  svg.appendChild(gridGroup);

  const axisGroup = createSvgEl("g", { class: "chart-axis" });
  years.forEach((year, index) => {
    const x = financialChartState.scaleX(index);
    const label = createSvgEl("text", {
      x,
      y: height - 8,
      fill: "rgba(12, 26, 14, 0.5)",
      "font-size": 10,
      "text-anchor": "middle"
    });
    label.textContent = year;
    axisGroup.appendChild(label);
  });
  svg.appendChild(axisGroup);

  const dataGroup = createSvgEl("g", { class: "chart-data" });
  const revenuePath = createSvgEl("path", {
    d: "",
    fill: "none",
    stroke: "url(#chart-gradient-primary)",
    "stroke-width": 3,
    "stroke-linecap": "round",
    "stroke-linejoin": "round",
    class: "chart-line primary",
    filter: "url(#chart-glow)"
  });

  const netPath = createSvgEl("path", {
    d: "",
    fill: "none",
    stroke: "url(#chart-gradient-secondary)",
    "stroke-width": 3,
    "stroke-linecap": "round",
    "stroke-linejoin": "round",
    class: "chart-line secondary",
    filter: "url(#chart-glow)"
  });

  dataGroup.appendChild(revenuePath);
  dataGroup.appendChild(netPath);

  const primaryDots = [];
  const secondaryDots = [];

  years.forEach(() => {
    const dot = createSvgEl("circle", {
      r: 4,
      fill: "#7ED957",
      class: "chart-dot primary",
      filter: "url(#chart-glow)"
    });
    dataGroup.appendChild(dot);
    primaryDots.push(dot);
  });

  years.forEach(() => {
    const dot = createSvgEl("circle", {
      r: 4,
      fill: "#5A8F3A",
      class: "chart-dot secondary",
      filter: "url(#chart-glow)"
    });
    dataGroup.appendChild(dot);
    secondaryDots.push(dot);
  });

  svg.appendChild(dataGroup);

  financialChartState.paths.primary = revenuePath;
  financialChartState.paths.secondary = netPath;
  financialChartState.dots.primary = primaryDots;
  financialChartState.dots.secondary = secondaryDots;

  const initialData = financialScenarios[currentScenario];
  applyFinancialChartData(initialData);
  financialChartState.currentData = {
    primary: [...initialData.primary],
    secondary: [...initialData.secondary]
  };
  financialChartState.currentScenario = currentScenario;
}

function buildFinancialPath(dataset) {
  return dataset
    .map((value, index) => {
      const x = financialChartState.scaleX(index);
      const y = financialChartState.scaleY(value);
      return `${index === 0 ? "M" : "L"}${x} ${y}`;
    })
    .join(" ");
}

function applyFinancialChartData(data) {
  financialChartState.paths.primary.setAttribute("d", buildFinancialPath(data.primary));
  financialChartState.paths.secondary.setAttribute("d", buildFinancialPath(data.secondary));

  data.primary.forEach((value, index) => {
    const dot = financialChartState.dots.primary[index];
    dot.setAttribute("cx", financialChartState.scaleX(index));
    dot.setAttribute("cy", financialChartState.scaleY(value));
  });

  data.secondary.forEach((value, index) => {
    const dot = financialChartState.dots.secondary[index];
    dot.setAttribute("cx", financialChartState.scaleX(index));
    dot.setAttribute("cy", financialChartState.scaleY(value));
  });
}

function animateFinancialChart(lang, scenarioKey) {
  initFinancialChart(lang);
  if (!financialChartState.svg) return;

  if (financialChartState.currentScenario === scenarioKey && financialChartState.currentData) {
    updateFinancialAxisLabels(lang);
    return;
  }

  const target = financialScenarios[scenarioKey];
  const startData = financialChartState.currentData || target;

  if (financialChartState.animationId) {
    cancelAnimationFrame(financialChartState.animationId);
  }

  financialChartState.currentScenario = scenarioKey;

  const start = performance.now();
  const duration = financialChartConfig.duration;
  const easeOut = (t) => 1 - Math.pow(1 - t, 3);

  const tick = (now) => {
    const progress = Math.min((now - start) / duration, 1);
    const eased = easeOut(progress);

    const nextPrimary = startData.primary.map(
      (value, index) => value + (target.primary[index] - value) * eased
    );
    const nextSecondary = startData.secondary.map(
      (value, index) => value + (target.secondary[index] - value) * eased
    );

    applyFinancialChartData({ primary: nextPrimary, secondary: nextSecondary });
    financialChartState.currentData = { primary: nextPrimary, secondary: nextSecondary };

    if (progress < 1) {
      financialChartState.animationId = requestAnimationFrame(tick);
    } else {
      financialChartState.currentData = {
        primary: [...target.primary],
        secondary: [...target.secondary]
      };
      financialChartState.animationId = null;
    }
  };

  financialChartState.animationId = requestAnimationFrame(tick);
}

function renderFinancialChart(lang, scenarioKey) {
  animateFinancialChart(lang, scenarioKey);
}

function renderFinancialTable(lang, scenarioKey) {
  const tbody = document.getElementById("financial-table-body");
  if (!tbody) return;
  tbody.innerHTML = "";

  const data = financialScenarios[scenarioKey];

  data.years.forEach((year, index) => {
    const tr = document.createElement("tr");
    const yearTd = document.createElement("td");
    yearTd.textContent = year;
    const revTd = document.createElement("td");
    revTd.textContent = formatNumber(data.primary[index], lang);
    const netTd = document.createElement("td");
    netTd.textContent = formatNumber(data.secondary[index], lang);

    tr.appendChild(yearTd);
    tr.appendChild(revTd);
    tr.appendChild(netTd);
    tbody.appendChild(tr);
  });
}

function renderImpact(lang) {
  const packEl = document.querySelector('[data-impact="packs"]');
  const wasteEl = document.querySelector('[data-impact="waste"]');
  const co2El = document.querySelector('[data-impact="co2"]');
  if (!packEl || !wasteEl || !co2El) return;

  packEl.textContent = `${formatNumber(impactScenario.packs, lang)} ${translations[lang].impact_unit_packs}`;
  wasteEl.textContent = `${formatNumber(impactScenario.waste, lang)} ${translations[lang].impact_unit_waste}`;
  co2El.textContent = `${formatNumber(impactScenario.co2, lang)} ${translations[lang].impact_unit_co2}`;

  const maxValues = {
    packs: impactScenario.packs,
    waste: impactScenario.waste,
    co2: impactScenario.co2
  };

  document.querySelectorAll('[data-compare-value]').forEach((el) => {
    const metric = el.getAttribute('data-compare-value');
    const side = el.getAttribute('data-compare-side');
    const value = side === 'after' ? impactScenario[metric] : 0;
    el.textContent = formatNumber(value, lang);
  });

  document.querySelectorAll('[data-bar]').forEach((bar) => {
    const metric = bar.getAttribute('data-bar');
    const value = bar.getAttribute('data-value') ? parseFloat(bar.getAttribute('data-value')) : 0;
    const max = maxValues[metric] || 1;
    const width = value <= 0 ? 0 : (value / max) * 100;
    bar.style.width = `${width}%`;
  });

  const afterBars = document.querySelectorAll('.compare-panel.light .bar-fill');
  afterBars.forEach((bar) => {
    const metric = bar.getAttribute('data-bar');
    const width = (impactScenario[metric] / maxValues[metric]) * 100;
    bar.style.width = `${width}%`;
  });
}

function setupDemoModal() {
  const modal = document.getElementById("demo-modal");
  if (!modal) return;

  const form = document.getElementById("demo-form");
  const triggers = document.querySelectorAll("[data-demo-trigger]");
  const closeButtons = modal.querySelectorAll("[data-demo-close]");
  const firstInput = modal.querySelector("input");

  const openModal = () => {
    modal.classList.add("is-open");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
    if (firstInput) {
      firstInput.focus();
    }
  };

  const closeModal = () => {
    modal.classList.remove("is-open");
    modal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  };

  triggers.forEach((trigger) => {
    trigger.addEventListener("click", (event) => {
      event.preventDefault();
      openModal();
    });
  });

  closeButtons.forEach((button) => {
    button.addEventListener("click", () => closeModal());
  });

  modal.addEventListener("click", (event) => {
    if (event.target === modal || event.target.classList.contains("demo-backdrop")) {
      closeModal();
    }
  });

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && modal.classList.contains("is-open")) {
      closeModal();
    }
  });
}

function setupPinGate() {
  const overlay = document.getElementById("pin-overlay");
  const form = document.getElementById("pin-form");
  const input = document.getElementById("pin-input");
  const error = document.getElementById("pin-error");
  if (!overlay || !form || !input || !error) return;

  const unlock = () => {
    overlay.classList.add("is-hidden");
    overlay.setAttribute("aria-hidden", "true");
    document.body.classList.remove("pin-locked");
    overlay.style.display = "none";
  };

  if (sessionStorage.getItem(PIN_STORAGE_KEY) === "true") {
    unlock();
    return;
  }

  document.body.classList.add("pin-locked");

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const value = input.value.replace(/\D/g, "");
    if (value === PIN_CODE) {
      sessionStorage.setItem(PIN_STORAGE_KEY, "true");
      unlock();
      input.value = "";
      return;
    }

    error.classList.add("is-visible");
    input.classList.add("is-error");
    input.value = "";
    setTimeout(() => {
      error.classList.remove("is-visible");
      input.classList.remove("is-error");
    }, 1800);
  });
}

function setupReveal() {
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.12 }
  );

  document.querySelectorAll('.reveal').forEach((el) => observer.observe(el));
}

function initLanguage() {
  const stored = localStorage.getItem('pharmasave-lang');
  const defaultLang = stored || 'it';
  const storedScenario = localStorage.getItem("pharmasave-scenario");
  if (storedScenario === "with" || storedScenario === "without") {
    currentScenario = storedScenario;
  }
  setLang(defaultLang);

  document.querySelectorAll('.lang-toggle button').forEach((btn) => {
    btn.addEventListener('click', () => {
      const lang = btn.dataset.lang;
      localStorage.setItem('pharmasave-lang', lang);
      setLang(lang);
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  setupPinGate();
  initLanguage();
  setupScenarioToggle();
  setupDemoModal();
  setupReveal();
});
